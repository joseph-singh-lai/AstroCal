<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Sky Map — AstroCal (Web Engine)</title>
  <style>
    :root{
      --bg:#0b0f1a; --card:#0f1724; --accent:#7dd3fc; --muted:#94a3b8; --radius:10px;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#02040a 0%, #06111f 100%);color:#e6eef6}
    header{padding:1rem 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    h1{font-size:1.1rem;margin:0;color:var(--accent)}
    .controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .btn{background:var(--card);color:var(--accent);border:1px solid rgba(125,211,252,0.06);padding:.5rem .7rem;border-radius:8px;cursor:pointer;transition:all 0.2s ease;font-size:0.9rem}
    .btn:hover{background:rgba(125,211,252,0.1);border-color:rgba(125,211,252,0.2)}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .btn.secondary:hover{background:rgba(255,255,255,0.05);color:var(--accent)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .panel{padding:1rem;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 20px rgba(2,6,23,0.6);margin:1rem}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:1rem;padding:0 1rem 1.5rem}
    @media (max-width:900px){.layout{grid-template-columns:1fr}.sidebar{order:2}.mapwrap{order:1}}
    .sidebar{min-height:360px}
    label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:.25rem}
    input[type="date"], input[type="time"], select, input[type="number"]{width:100%;padding:.45rem .5rem;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;transition:border-color 0.2s ease}
    input[type="date"]:focus, input[type="time"]:focus, select:focus, input[type="number"]:focus{outline:none;border-color:var(--accent)}
    .mapwrap{border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 32px rgba(0,0,0,0.3);position:relative;height:78vh;min-height:500px}
    #stellarium-container{width:100%;height:100%;position:relative}
    #stellarium-canvas{width:100%;height:100%;display:block}
    .small{font-size:.8rem;color:var(--muted)}
    .row{display:flex;gap:.6rem;align-items:center}
    .footer{padding:1rem;text-align:center;color:var(--muted);font-size:.85rem}
    .back-link{color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 0;transition:opacity 0.2s ease}
    .back-link:hover{opacity:0.8}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--muted);z-index:10;text-align:center}
    .loading-spinner{width:40px;height:40px;border:3px solid rgba(125,211,252,0.3);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem}
    .error{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;text-align:center;z-index:10;background:var(--card);padding:1rem;border-radius:8px;border:1px solid rgba(255,107,107,0.3);max-width:400px}
    .fallback-notice{background:rgba(255,193,7,0.1);border:1px solid rgba(255,193,7,0.3);padding:0.75rem;border-radius:8px;margin-top:1rem;font-size:0.85rem;color:#ffc107}
    .fallback-notice a{color:var(--accent);text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div>
      <a href="index.html" class="back-link">← Back to Events</a>
      <h1>Interactive Sky Map — La Brea, Trinidad</h1>
    </div>
    <div class="controls">
      <button id="btn-now" class="btn">Now</button>
      <button id="btn-geoloc" class="btn">Use My Location</button>
      <button id="btn-fallback" class="btn secondary" onclick="window.location.href='sky-map.html'">Use Iframe Version</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar panel">
      <div style="margin-bottom: .6rem;"><strong class="small">Location</strong></div>
      <div class="row" style="gap:.5rem;margin-bottom:.8rem">
        <div style="flex:1">
          <label class="small">Latitude</label>
          <input id="input-lat" type="number" step="0.0001" value="10.25">
        </div>
        <div style="flex:1">
          <label class="small">Longitude</label>
          <input id="input-lon" type="number" step="0.0001" value="-61.63">
        </div>
      </div>

      <div style="margin-top:.4rem">
        <label class="small">Field of view (°)</label>
        <input id="input-fov" type="number" min="10" max="120" value="60">
      </div>

      <div style="margin-top:.8rem">
        <label class="small">Date</label>
        <input id="input-date" type="date">
      </div>
      <div style="margin-top:.6rem">
        <label class="small">Time (local)</label>
        <input id="input-time" type="time">
      </div>

      <div style="margin-top:1rem;display:flex;gap:.6rem;flex-direction:column">
        <label class="small" style="display:flex;align-items:center;gap:0.5rem">
          <input type="checkbox" id="show-constellations" checked style="width:auto">
          <span>Show Constellations</span>
        </label>
        <label class="small" style="display:flex;align-items:center;gap:0.5rem">
          <input type="checkbox" id="show-planets" checked style="width:auto">
          <span>Show Planets</span>
        </label>
        <label class="small" style="display:flex;align-items:center;gap:0.5rem">
          <input type="checkbox" id="show-stars" checked style="width:auto">
          <span>Show Stars</span>
        </label>
      </div>

      <div style="margin-top:1rem;display:flex;gap:.6rem">
        <button id="btn-update" class="btn">Update Sky</button>
        <button id="btn-reset" class="btn secondary">Reset</button>
      </div>

      <div id="fallback-notice" class="fallback-notice" style="display:none">
        <strong>⚠️ Web Engine not built</strong><br>
        Using fallback iframe. To use the Web Engine, run <code>.\build-stellarium.ps1</code> first.
        <br><a href="sky-map.html">Switch to iframe version</a>
      </div>
    </aside>

    <main class="mapwrap">
      <div id="loading-indicator" class="loading">
        <div class="loading-spinner"></div>
        <div>Loading Stellarium Web Engine...</div>
      </div>
      <div id="error-message" class="error" style="display:none">
        <div style="margin-bottom:0.5rem;">⚠️ Unable to load Web Engine</div>
        <div style="font-size:0.85rem;margin-bottom:0.5rem;">The engine files may not be built yet.</div>
        <button onclick="window.location.href='sky-map.html'" class="btn" style="margin-top:0.5rem;">Use Iframe Version</button>
        <button onclick="location.reload()" class="btn secondary" style="margin-top:0.5rem;margin-left:0.5rem;">Retry</button>
      </div>
      <div id="stellarium-container"></div>
    </main>
  </div>

  <div class="footer">Stellarium Web Engine • Default: La Brea, Trinidad • Built for night-friendly viewing</div>

  <!-- Load Stellarium Web Engine integration -->
  <script src="stellarium-engine.js"></script>
  
  <script>
    // Default coords for La Brea, Trinidad
    const DEFAULT_LAT = 10.25;
    const DEFAULT_LON = -61.63;

    const latInput = document.getElementById('input-lat');
    const lonInput = document.getElementById('input-lon');
    const fovInput = document.getElementById('input-fov');
    const dateInput = document.getElementById('input-date');
    const timeInput = document.getElementById('input-time');
    const showConstellations = document.getElementById('show-constellations');
    const showPlanets = document.getElementById('show-planets');
    const showStars = document.getElementById('show-stars');

    const btnUpdate = document.getElementById('btn-update');
    const btnNow = document.getElementById('btn-now');
    const btnGeoloc = document.getElementById('btn-geoloc');
    const btnReset = document.getElementById('btn-reset');
    const loadingIndicator = document.getElementById('loading-indicator');
    const errorMessage = document.getElementById('error-message');
    const fallbackNotice = document.getElementById('fallback-notice');

    let currentLat = DEFAULT_LAT;
    let currentLon = DEFAULT_LON;
    let currentFOV = 60;
    let currentDate = new Date();

    function toLocalIsoDate(d){ return d.toISOString().split('T')[0]; }
    function toLocalTimeString(d){ return d.toTimeString().split(' ')[0].slice(0,5); }

    function setNowInputs(){
      const now = new Date();
      dateInput.value = toLocalIsoDate(now);
      timeInput.value = toLocalTimeString(now);
      currentDate = now;
    }

    function updateSky(){
      currentLat = parseFloat(latInput.value) || DEFAULT_LAT;
      currentLon = parseFloat(lonInput.value) || DEFAULT_LON;
      currentFOV = parseFloat(fovInput.value) || 60;
      
      const dateStr = dateInput.value || toLocalIsoDate(new Date());
      const timeStr = timeInput.value || toLocalTimeString(new Date());
      currentDate = new Date(dateStr + 'T' + timeStr);

      if (window.StellariumEngine && window.StellariumEngine.isAvailable()) {
        window.StellariumEngine.setLocation(currentLat, currentLon);
        window.StellariumEngine.setDateTime(currentDate);
        window.StellariumEngine.setFOV(currentFOV);
        window.StellariumEngine.setDisplayOptions({
          showConstellations: showConstellations.checked,
          showPlanets: showPlanets.checked,
          showStars: showStars.checked
        });
      }
    }

    async function initEngine(){
      try {
        loadingIndicator.style.display = 'block';
        errorMessage.style.display = 'none';

        const success = await window.StellariumEngine.init('stellarium-container', {
          latitude: currentLat,
          longitude: currentLon,
          fov: currentFOV,
          date: currentDate,
          showConstellations: showConstellations.checked,
          showPlanets: showPlanets.checked,
          showStars: showStars.checked
        });

        if (success) {
          loadingIndicator.style.display = 'none';
          fallbackNotice.style.display = 'none';
        } else {
          throw new Error('Engine initialization failed');
        }
      } catch (error) {
        console.error('Engine initialization error:', error);
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'block';
        fallbackNotice.style.display = 'block';
      }
    }

    function loadDefault(){
      latInput.value = DEFAULT_LAT;
      lonInput.value = DEFAULT_LON;
      fovInput.value = 60;
      setNowInputs();
      updateSky();
    }

    btnUpdate.addEventListener('click', updateSky);
    btnNow.addEventListener('click', ()=>{ setNowInputs(); updateSky(); });
    btnReset.addEventListener('click', loadDefault);

    btnGeoloc.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        latInput.value = pos.coords.latitude.toFixed(5);
        lonInput.value = pos.coords.longitude.toFixed(5);
        setNowInputs();
        updateSky();
      }, err=>{ alert('Unable to get location: '+err.message); });
    });

    showConstellations.addEventListener('change', updateSky);
    showPlanets.addEventListener('change', updateSky);
    showStars.addEventListener('change', updateSky);

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      setNowInputs();
      
      // Check if engine is available
      if (window.StellariumEngine && window.StellariumEngine.isAvailable()) {
        initEngine();
      } else {
        // Show fallback notice
        loadingIndicator.style.display = 'none';
        errorMessage.style.display = 'block';
        fallbackNotice.style.display = 'block';
      }
    });
  </script>
</body>
</html>

